<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»æ°—æ¤…å­ã‚²ãƒ¼ãƒ  (PvP)</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* PvPãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pvp-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            background-color: var(--color-background-secondary);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .login-select-area {
            text-align: center;
            padding: 20px;
            border: 1px dashed var(--color-text);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            background-color: var(--color-background-primary);
        }
        .game-button {
            padding: 20px 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--color-text);
            background-color: var(--color-button-primary);
            border: 3px solid var(--color-accent);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s, box-shadow 0.15s;
            box-shadow: 0 3px 0 var(--color-accent-dark);
        }
        .game-button:hover:not(:disabled) {
            background-color: var(--color-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 0 var(--color-accent-dark);
        }
        .game-button:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 1px 0 var(--color-accent-dark);
        }
        .game-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ */
        .selected-by-creator {
            background-color: #4CAF50 !important; /* Green */
            border-color: #388E3C !important;
            color: white !important;
            box-shadow: 0 3px 0 #388E3C;
        }
        .selected-by-joiner {
            background-color: #2196F3 !important; /* Blue */
            border-color: #1976D2 !important;
            color: white !important;
            box-shadow: 0 3px 0 #1976D2;
        }
        .shocked-button {
            background-color: #F44336 !important; /* Red */
            border-color: #D32F2F !important;
            color: yellow !important;
            animation: pulse-shock 0.5s infinite alternate;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8), 0 3px 0 #D32F2F;
        }

        .current-turn {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
            text-align: center;
        }
        .my-turn {
            background-color: #e0ffe0; /* Green tint */
            color: #388E3C;
        }
        .opponent-turn {
            background-color: #e0f2ff; /* Blue tint */
            color: #1976D2;
        }
        
        .dark-mode .my-turn { background-color: #1a4d1a; color: #a5d6a7; }
        .dark-mode .opponent-turn { background-color: #1a2a4d; color: #a5c3d6; }
        .dark-mode .shocked-button { color: #ffe082 !important; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±è¡¨ç¤º */
        .player-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--color-background-primary);
        }
        .player-info div {
            flex-basis: 48%;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
        }
        .player-info .player-name-display {
            font-weight: bold;
            font-size: 1.1em;
        }
        .player-info .creator-side { border: 2px solid #4CAF50; }
        .player-info .joiner-side { border: 2px solid #2196F3; }

        /* ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å…¥åŠ›/è¡¨ç¤º */
        .code-area {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
        }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        #game-message {
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            min-height: 40px;
        }
        .hidden { display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        .dark-mode .success { background-color: #1f4427; color: #a5d6a7; }
        .dark-mode .error { background-color: #4d1c1c; color: #f8d7da; }
        .dark-mode .info { background-color: #1c364d; color: #d1ecf1; }
        
        @keyframes pulse-shock {
            from { box-shadow: 0 0 15px rgba(255, 0, 0, 0.8), 0 3px 0 #D32F2F; }
            to { box-shadow: 0 0 25px rgba(255, 100, 100, 1), 0 3px 0 #D32F2F; }
        }
    </style>
</head>
<body>
    <header>
        <h1>é›»æ°—æ¤…å­ã‚²ãƒ¼ãƒ  (PvP)</h1>
    </header>

    <main>
        <div class="pvp-container">
            <div id="login-screen">
                <h2>ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="login-select-area">
                    <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è‡ªåˆ†ã®åå‰ã‚’é¸æŠã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    <select id="player-select" class="input-field" style="width: 100%; margin-bottom: 10px;">
                        <option value="">-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ --</option>
                        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    </select>
                    <!-- â˜… æ–°è¦è¿½åŠ : ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <input type="password" id="password-input" class="input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; margin-bottom: 10px;">
                    
                    <input type="number" id="bet-points-input" class="input-field" placeholder="è³­ã‘ãƒã‚¤ãƒ³ãƒˆ (ä¾‹: 100)" min="10" value="100" style="width: 100%; margin-bottom: 10px;">
                    <button id="login-button" class="action-button">ãƒ­ã‚°ã‚¤ãƒ³ & ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                    <p id="login-error" class="error hidden" style="margin-top: 10px;"></p>
                </div>
            </div>

            <div id="game-setup-screen" class="hidden">
                <h2>ğŸ•¹ï¸ ã‚²ãƒ¼ãƒ è¨­å®šãƒ»å‚åŠ </h2>
                <div id="game-message" class="info hidden"></div>

                <div class="action-section">
                    <h3>ã‚²ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ (ãƒ›ã‚¹ãƒˆ)</h3>
                    <button id="create-game-button" class="action-button">ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ</button>
                    <div id="created-game-info" class="hidden info-box" style="margin-top: 10px;">
                        <p>ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰: <strong id="display-game-code" style="font-size: 1.2em; color: var(--color-accent);"></strong></p>
                        <p>ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™... (ç”»é¢ã‚’é–‹ã„ãŸã¾ã¾ãŠå¾…ã¡ãã ã•ã„)</p>
                    </div>
                </div>

                <hr style="margin: 20px 0;">

                <div class="action-section">
                    <h3>ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ (ã‚²ã‚¹ãƒˆ)</h3>
                    <input type="text" id="join-code-input" class="input-field" placeholder="ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ› (ä¾‹: XYZ123)" maxlength="6">
                    <button id="join-game-button" class="action-button primary">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <div class="action-section">
                    <h3>é–‹å‚¬ä¸­ã®ã‚²ãƒ¼ãƒ </h3>
                    <div id="waiting-games-list">
                        <!-- å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        <p class="info-text">ç¾åœ¨ã€å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </div>

            <div id="game-play-screen" class="hidden">
                <div class="code-area">
                    <p>å¯¾æˆ¦ã‚³ãƒ¼ãƒ‰: <strong id="current-game-code" style="font-size: 1.5em; color: var(--color-accent);"></strong></p>
                    <p>è³­ã‘ãƒã‚¤ãƒ³ãƒˆ: <strong id="display-bet-points"></strong> P</p>
                </div>
                
                <div id="game-message-play" class="info hidden"></div>

                <div class="player-info">
                    <div class="creator-side">
                        <p>ãƒ›ã‚¹ãƒˆ:</p>
                        <p class="player-name-display" id="player-creator-name"></p>
                    </div>
                    <div class="joiner-side">
                        <p>ã‚²ã‚¹ãƒˆ:</p>
                        <p class="player-name-display" id="player-joiner-name"></p>
                    </div>
                </div>

                <div id="turn-status" class="current-turn opponent-turn">
                    <!-- ã‚¿ãƒ¼ãƒ³æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                
                <h3 style="text-align: center; margin-top: 20px;">âš¡ é›»æ°—æ¤…å­ãƒœã‚¿ãƒ³ (å…¨10å€‹) âš¡</h3>
                <div id="button-grid" class="button-grid">
                    <!-- ãƒœã‚¿ãƒ³ãŒJavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="return-to-setup" class="action-button secondary">ã‚²ãƒ¼ãƒ é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                </div>
            </div>
            
            <p id="system-error" class="error hidden" style="text-align: center; margin-top: 20px;"></p>
        </div>
    </main>

    <footer>
        <nav class="footer-nav">
            <a href="index.html" class="input-link">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
            <a href="mypage.html" class="input-link">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
            <a href="pvp.html" class="input-link current">å¯¾æˆ¦(PvP)</a> 
            <a href="master.html" class="input-link">ãƒã‚¹ã‚¿ãƒ¼</a>
        </nav>
    </footer>

    <script src="assets/js/common.js"></script>
    <script>
        // --- çŠ¶æ…‹ç®¡ç† ---
        let localPlayer = {
            name: null,
            userId: null,
            role: null, // 'creator' or 'joiner'
            betPoints: 100,
            passwordHash: null // èªè¨¼ç”¨ãƒãƒƒã‚·ãƒ¥
        };
        let currentGame = null;
        let pollingInterval = null;
        const POLLING_RATE = 5000; // 5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
        
        let allPlayerData = []; // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥å«ã‚€ï¼‰ã‚’ä¿å­˜

        // --- DOMè¦ç´  ---
        const $loginScreen = document.getElementById('login-screen');
        const $gameSetupScreen = document.getElementById('game-setup-screen');
        const $gamePlayScreen = document.getElementById('game-play-screen');
        const $playerSelect = document.getElementById('player-select');
        const $passwordInput = document.getElementById('password-input'); // â˜… æ–°è¦è¿½åŠ 
        const $betPointsInput = document.getElementById('bet-points-input');
        const $loginButton = document.getElementById('login-button');
        const $loginError = document.getElementById('login-error');
        const $gameMessage = document.getElementById('game-message');
        const $gameMessagePlay = document.getElementById('game-message-play');
        const $createGameButton = document.getElementById('create-game-button');
        const $joinCodeInput = document.getElementById('join-code-input');
        const $joinGameButton = document.getElementById('join-game-button');
        const $waitingGamesList = document.getElementById('waiting-games-list');
        const $displayGameCode = document.getElementById('display-game-code');
        const $createdGameInfo = document.getElementById('created-game-info');
        const $currentTurn = document.getElementById('turn-status');
        const $buttonGrid = document.getElementById('button-grid');
        const $systemError = document.getElementById('system-error');
        const $displayBetPoints = document.getElementById('display-bet-points');
        const $playerCreatorName = document.getElementById('player-creator-name');
        const $playerJoinerName = document.getElementById('player-joiner-name');
        const $currentGameCode = document.getElementById('current-game-code');
        const $returnToSetup = document.getElementById('return-to-setup');

        /**
         * ç”»é¢é·ç§»ãƒ˜ãƒ«ãƒ‘ãƒ¼
         * @param {string} screenId - 'login', 'setup', 'play'
         */
        function switchScreen(screenId) {
            $loginScreen.classList.add('hidden');
            $gameSetupScreen.classList.add('hidden');
            $gamePlayScreen.classList.add('hidden');
            $systemError.classList.add('hidden');
            
            // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            if (screenId === 'login') {
                $loginScreen.classList.remove('hidden');
            } else if (screenId === 'setup') {
                $gameSetupScreen.classList.remove('hidden');
                // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã£ãŸã‚‰ã€å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                startPollingWaitingGames();
            } else if (screenId === 'play') {
                $gamePlayScreen.classList.remove('hidden');
                // ã‚²ãƒ¼ãƒ ç”»é¢ã«å…¥ã£ãŸã‚‰ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                startPollingGameStatus();
            }
        }

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---

        /**
         * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¡¨ç¤º
         */
        async function loadPlayerList() {
            try {
                // common.jsã‹ã‚‰å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒã‚·ãƒ¥å«ã‚€ï¼‰ã‚’å–å¾—
                allPlayerData = await fetchPlayerData(); 
                
                $playerSelect.innerHTML = '<option value="">-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ --</option>';
                allPlayerData.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    // userIdã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹
                    option.dataset.userId = player.name; 
                    $playerSelect.appendChild(option);
                });
                
            } catch (error) {
                showMessage($systemError, `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }
        
        /**
         * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹é–¢æ•° (ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨åŒä¸€ã§ã‚ã‚‹ã¨æƒ³å®š)
         * @param {string} password - å…¥åŠ›ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
         * @returns {Promise<string>} - SHA-256ãƒãƒƒã‚·ãƒ¥ (å°æ–‡å­—ã®16é€²æ•°)
         */
        async function hashPassword(password) {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ã‚„ãƒã‚¹ã‚¿ãƒ¼ç”»é¢ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒãƒƒã‚·ãƒ¥åŒ–æ–¹æ³•ã«ä¾å­˜ï¼‰
            // ã“ã“ã§ã¯æ¨™æº–ã®Web Crypto APIã‚’ä½¿ç”¨ (ç’°å¢ƒã«ã‚ˆã£ã¦ã¯polyfillãŒå¿…è¦ãªå ´åˆã‚ã‚Š)
            if (!crypto.subtle) {
                 // Web Crypto APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæœ¬ç•ªã§ã¯æ¨å¥¨ã•ã‚Œãªã„ï¼‰
                 console.warn("Web Crypto API is not available. Using simple hashing fallback.");
                 return password; 
            }

            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            // ãƒãƒƒã‚·ãƒ¥ãƒãƒƒãƒ•ã‚¡ã‚’16é€²æ•°æ–‡å­—åˆ—ã«å¤‰æ›
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        $loginButton.addEventListener('click', async () => {
            const selectedOption = $playerSelect.options[$playerSelect.selectedIndex];
            const playerName = selectedOption.value;
            const inputPassword = $passwordInput.value; // â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
            const betPoints = parseInt($betPointsInput.value, 10);

            showMessage($loginError, '', 'error');
            $loginError.classList.add('hidden');

            if (!playerName) {
                showMessage($loginError, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            if (!inputPassword) { // â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
                showMessage($loginError, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            if (isNaN(betPoints) || betPoints < 10) {
                 showMessage($loginError, 'æœ‰åŠ¹ãªè³­ã‘ãƒã‚¤ãƒ³ãƒˆï¼ˆ10Pä»¥ä¸Šï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿æ¤œç´¢
            const player = allPlayerData.find(p => p.name === playerName);

            if (!player) {
                showMessage($loginError, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
            try {
                const hashedPassword = await hashPassword(inputPassword);
                
                if (player.passwordHash !== hashedPassword) {
                    showMessage($loginError, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
            } catch (e) {
                showMessage($loginError, 'èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                return;
            }

            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ã‚²ãƒ¼ãƒ è¨­å®šç”»é¢ã¸
            localPlayer.name = playerName;
            localPlayer.userId = player.name; // userIdã¯åå‰ã‚’ä½¿ç”¨
            localPlayer.betPoints = betPoints;
            localPlayer.passwordHash = player.passwordHash; // èªè¨¼æ¸ˆã¿ã®ãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
            
            console.log(`[LOGIN SUCCESS] Player: ${localPlayer.name}, ID: ${localPlayer.userId}`);

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã€ç”»é¢é·ç§»
            switchScreen('setup');
        });

        // --- ã‚²ãƒ¼ãƒ ä½œæˆ/å‚åŠ å‡¦ç† ---
        
        $createGameButton.addEventListener('click', createGame);
        $joinGameButton.addEventListener('click', joinGameFromInput);
        $returnToSetup.addEventListener('click', () => {
             // é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰ãŒå¿…è¦ã ãŒã€ä»Šå›ã¯ç°¡æ˜“çš„ã«æˆ»ã‚‹
             // TODO: é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã¯å‚åŠ è€…ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€è‡ªå‹•ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦
            currentGame = null;
            localPlayer.role = null;
            switchScreen('setup');
            showMessage($gameMessage, 'ã‚²ãƒ¼ãƒ é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã—ãŸã€‚', 'info');
        });

        /**
         * 6æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
         */
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        /**
         * ã‚²ãƒ¼ãƒ ä½œæˆå‡¦ç†
         */
        async function createGame() {
            showMessage($gameMessage, 'ã‚²ãƒ¼ãƒ ã‚’ä½œæˆä¸­...', 'info');
            $createGameButton.disabled = true;

            try {
                const allPvpData = await fetchPvpData();
                const pvpGames = allPvpData.pvp_games;
                
                // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã«è‡ªåˆ†ãŒã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã¨ã—ã¦å¾…æ©Ÿã—ã¦ã„ãªã„ã‹ç¢ºèª
                const existingCreatorGame = pvpGames.find(g => 
                    g.status === 'WAITING' && g.players.creator.name === localPlayer.name
                );

                if (existingCreatorGame) {
                    showMessage($gameMessage, `æ—¢ã«ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ <strong style="color:var(--color-accent);">${existingCreatorGame.gameCode}</strong> ã§å¾…æ©Ÿä¸­ã§ã™ã€‚`, 'error');
                    // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã§å¾…æ©Ÿ
                    $displayGameCode.textContent = existingCreatorGame.gameCode;
                    $createdGameInfo.classList.remove('hidden');
                    currentGame = existingCreatorGame;
                    localPlayer.role = 'creator';
                    // å¾…æ©Ÿãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                    startPollingWaitingGames(existingCreatorGame.gameCode);
                    $createGameButton.disabled = false;
                    return;
                }

                const newGameCode = generateGameCode();
                
                // 10å€‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ã‚’æ„Ÿé›»ãƒœã‚¿ãƒ³ã«è¨­å®š
                const shockButtonIndex = Math.floor(Math.random() * 10); 

                const newGame = {
                    gameCode: newGameCode,
                    status: "WAITING", 
                    betPoints: localPlayer.betPoints,
                    currentTurn: 1,
                    players: {
                        creator: {
                            name: localPlayer.name,
                            userId: localPlayer.userId,
                            isTurn: true, // ä½œæˆè€…ãŒå…ˆæ”»
                            selectedButtons: [],
                            isShocked: false,
                            pointsChange: 0
                        },
                        joiner: null // å‚åŠ è€…å¾…ã¡
                    },
                    gameSettings: {
                        totalButtons: 10,
                        shockButtonIndex: shockButtonIndex,
                        maxRounds: 5 // å¿µã®ãŸã‚ã®è¨­å®šï¼ˆä½¿ã‚ãªã„å¯èƒ½æ€§ã‚ã‚Šï¼‰
                    },
                    createdAt: new Date().toISOString()
                };

                pvpGames.push(newGame);

                const updateResult = await updatePvpData(allPvpData);

                if (updateResult.status === 'success') {
                    currentGame = newGame;
                    localPlayer.role = 'creator';
                    $displayGameCode.textContent = newGameCode;
                    $createdGameInfo.classList.remove('hidden');
                    showMessage($gameMessage, `ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ <strong style="color:var(--color-accent);">${newGameCode}</strong> ã‚’ç™ºè¡Œã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚`, 'success');
                    // å¾…æ©Ÿãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                    startPollingWaitingGames(newGameCode);
                } else {
                    throw new Error(updateResult.message);
                }

            } catch (error) {
                showMessage($gameMessage, `ã‚²ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            } finally {
                $createGameButton.disabled = false;
            }
        }
        
        /**
         * ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã«ã‚ˆã‚‹å‚åŠ å‡¦ç†
         */
        async function joinGameFromInput() {
            const code = $joinCodeInput.value.toUpperCase().trim();
            if (code.length !== 6) {
                showMessage($gameMessage, 'ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã¯6æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            await joinGame(code);
        }

        /**
         * ã‚²ãƒ¼ãƒ å‚åŠ å‡¦ç†
         * @param {string} gameCode - å‚åŠ ã™ã‚‹ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰
         */
        async function joinGame(gameCode) {
            showMessage($gameMessage, `ã‚²ãƒ¼ãƒ  <strong style="color:var(--color-accent);">${gameCode}</strong> ã«å‚åŠ ã‚’è©¦ã¿ã¦ã„ã¾ã™...`, 'info');
            $joinGameButton.disabled = true;

            try {
                const allPvpData = await fetchPvpData();
                const pvpGames = allPvpData.pvp_games;

                const gameIndex = pvpGames.findIndex(g => g.gameCode === gameCode);
                const game = pvpGames[gameIndex];

                if (gameIndex === -1 || game.status !== 'WAITING') {
                    showMessage($gameMessage, `ã‚³ãƒ¼ãƒ‰ <strong style="color:var(--color-accent);">${gameCode}</strong> ã®ã‚²ãƒ¼ãƒ ã¯è¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€æ—¢ã«é–‹å§‹ã¾ãŸã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚`, 'error');
                    return;
                }
                
                if (game.players.creator.name === localPlayer.name) {
                    showMessage($gameMessage, 'ä½œæˆã—ãŸã‚²ãƒ¼ãƒ ã«ã¯å‚åŠ ã§ãã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
                
                if (game.betPoints !== localPlayer.betPoints) {
                    showMessage($gameMessage, `ã“ã®ã‚²ãƒ¼ãƒ ã®è³­ã‘ãƒã‚¤ãƒ³ãƒˆã¯ <strong style="color:var(--color-accent);">${game.betPoints} P</strong> ã§ã™ã€‚ã‚ãªãŸã®è¨­å®š ${localPlayer.betPoints} P ã¨ç•°ãªã‚‹ãŸã‚å‚åŠ ã§ãã¾ã›ã‚“ã€‚`, 'error');
                    return;
                }

                // å‚åŠ è€…æƒ…å ±ã‚’è¨­å®š
                game.players.joiner = {
                    name: localPlayer.name,
                    userId: localPlayer.userId,
                    isTurn: false,
                    selectedButtons: [],
                    isShocked: false,
                    pointsChange: 0
                };
                game.status = 'PLAYING'; // ã‚²ãƒ¼ãƒ é–‹å§‹

                const updateResult = await updatePvpData(allPvpData);

                if (updateResult.status === 'success') {
                    currentGame = game;
                    localPlayer.role = 'joiner';
                    showMessage($gameMessage, `ã‚²ãƒ¼ãƒ  <strong style="color:var(--color-accent);">${gameCode}</strong> ã«å‚åŠ ã—ã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ é–‹å§‹ï¼`, 'success');
                    switchScreen('play');
                } else {
                    throw new Error(updateResult.message);
                }

            } catch (error) {
                showMessage($gameMessage, `ã‚²ãƒ¼ãƒ å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            } finally {
                $joinGameButton.disabled = false;
            }
        }
        
        // --- å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆæç”» ---
        
        /**
         * å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’æç”»
         */
        function renderWaitingGamesList(pvpGames) {
            if (localPlayer.role === 'creator' && currentGame && currentGame.status === 'WAITING') {
                // ä½œæˆè€…ã¯è‡ªåˆ†ã®ã‚²ãƒ¼ãƒ ã®å¾…æ©Ÿæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒªã‚¹ãƒˆã¯è¡¨ç¤ºã—ãªã„
                $waitingGamesList.innerHTML = '';
                return;
            }
            
            // å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const waitingGames = pvpGames.filter(g => 
                g.status === 'WAITING' && g.players.creator.name !== localPlayer.name
            );

            if (waitingGames.length === 0) {
                $waitingGamesList.innerHTML = '<p class="info-text">ç¾åœ¨ã€å‚åŠ å¯èƒ½ãªå¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            let html = '<ul style="list-style-type: none; padding: 0;">';
            waitingGames.forEach(game => {
                html += `
                    <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed var(--color-border);">
                        <span>
                            <strong style="color:#4CAF50;">${game.players.creator.name}</strong> 
                            (ã‚³ãƒ¼ãƒ‰: <strong style="color:var(--color-accent);">${game.gameCode}</strong>, è³­ã‘: ${game.betPoints} P)
                        </span>
                        <button class="action-button small join-list-button" data-code="${game.gameCode}">å‚åŠ </button>
                    </li>
                `;
            });
            html += '</ul>';
            $waitingGamesList.innerHTML = html;

            // å‚åŠ ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.join-list-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    joinGame(code);
                });
            });
        }


        // --- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ã®æç”»ã¨ãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ã®åˆæœŸåŒ–ã¨æç”»
         */
        function renderGame() {
            if (!currentGame || !localPlayer.role) return;

            const creator = currentGame.players.creator;
            const joiner = currentGame.players.joiner;
            const myPlayer = localPlayer.role === 'creator' ? creator : joiner;
            const opponentPlayer = localPlayer.role === 'creator' ? joiner : creator;
            
            // ç”»é¢æƒ…å ±è¡¨ç¤ºã®æ›´æ–°
            $currentGameCode.textContent = currentGame.gameCode;
            $displayBetPoints.textContent = currentGame.betPoints;
            $playerCreatorName.textContent = creator.name;
            $playerJoinerName.textContent = joiner ? joiner.name : 'ç›¸æ‰‹å¾…ã¡...';
            
            // ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã®æ›´æ–°
            let turnText = '';
            let isMyTurn = false;
            if (currentGame.status === 'PLAYING') {
                if (myPlayer.isTurn) {
                    turnText = 'ğŸ”¥ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
                    $currentTurn.classList.remove('opponent-turn');
                    $currentTurn.classList.add('my-turn');
                    isMyTurn = true;
                } else {
                    // ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãŒã¾ã ãªã„å ´åˆã‚’è€ƒæ…®
                    const opponentName = opponentPlayer ? opponentPlayer.name : 'ç›¸æ‰‹';
                    turnText = `${opponentName} ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚å¾…æ©Ÿä¸­...`;
                    $currentTurn.classList.remove('my-turn');
                    $currentTurn.classList.add('opponent-turn');
                }
            } else if (currentGame.status === 'WAITING') {
                 turnText = 'ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...';
            } else if (currentGame.status === 'FINISHED') {
                 turnText = 'ã‚²ãƒ¼ãƒ çµ‚äº†ï¼';
            }
            $currentTurn.innerHTML = `<p style="margin: 0;">ã‚¿ãƒ¼ãƒ³ ${currentGame.currentTurn}: ${turnText}</p>`;
            
            // ãƒœã‚¿ãƒ³ã®æç”»
            renderButtons(isMyTurn);
            
            // å‹æ•—åˆ¤å®šã¨çµæœè¡¨ç¤º
            if (currentGame.status === 'FINISHED') {
                displayGameResult();
            }
            
            // åˆå›è¡¨ç¤º
            if ($gamePlayScreen.classList.contains('hidden')) {
                switchScreen('play');
            }
        }
        
        /**
         * ãƒœã‚¿ãƒ³ã®æç”»ã¨çŠ¶æ…‹è¨­å®š
         * @param {boolean} isMyTurn - ç¾åœ¨è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹
         */
        function renderButtons(isMyTurn) {
            $buttonGrid.innerHTML = ''; // ã‚¯ãƒªã‚¢
            const totalButtons = currentGame.gameSettings.totalButtons;
            
            const selectedButtons = [
                ...currentGame.players.creator.selectedButtons.map(i => ({ index: i, role: 'creator' })),
                ...(currentGame.players.joiner ? currentGame.players.joiner.selectedButtons.map(i => ({ index: i, role: 'joiner' })) : [])
            ];
            
            for (let i = 0; i < totalButtons; i++) {
                const button = document.createElement('button');
                button.className = 'game-button';
                button.textContent = i + 1;
                button.dataset.index = i;
                
                const selectedInfo = selectedButtons.find(s => s.index === i);
                
                if (selectedInfo) {
                    // æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³
                    button.disabled = true;
                    if (selectedInfo.role === 'creator') {
                        button.classList.add('selected-by-creator');
                    } else {
                        button.classList.add('selected-by-joiner');
                    }
                    
                    // çµ‚äº†æ™‚ã«ã‚·ãƒ§ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    if (currentGame.status === 'FINISHED' && i === currentGame.gameSettings.shockButtonIndex) {
                        button.classList.add('shocked-button');
                        button.textContent = 'âš¡ï¸ SHOCK âš¡ï¸';
                    }

                } else if (currentGame.status === 'PLAYING' && isMyTurn) {
                    // æœªé¸æŠã§ã€ã‚²ãƒ¼ãƒ ä¸­ã§ã€è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆã®ã¿æœ‰åŠ¹
                    button.disabled = false;
                    button.addEventListener('click', handleButtonPress);
                } else {
                    // æœªé¸æŠã ãŒã€ç„¡åŠ¹ãªçŠ¶æ…‹
                    button.disabled = true;
                }
                
                $buttonGrid.appendChild(button);
            }
        }
        
        /**
         * ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
         */
        async function handleButtonPress(event) {
            const buttonIndex = parseInt(event.target.dataset.index, 10);
            
            if (currentGame.status !== 'PLAYING' || !localPlayer.role) return;
            
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã“ã¨ã®æœ€çµ‚ç¢ºèª
            const myPlayerKey = localPlayer.role; // 'creator' or 'joiner'
            if (!currentGame.players[myPlayerKey].isTurn) {
                showMessage($gameMessagePlay, 'ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼', 'error');
                return;
            }
            
            // å…¨ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
            document.querySelectorAll('.game-button').forEach(btn => btn.disabled = true);
            showMessage($gameMessagePlay, `${buttonIndex + 1}ç•ªã®ãƒœã‚¿ãƒ³ã‚’é¸æŠã—ã¾ã—ãŸ...`, 'info');

            try {
                // 1. ã‚·ãƒ§ãƒƒã‚¯åˆ¤å®š
                const isShock = buttonIndex === currentGame.gameSettings.shockButtonIndex;
                
                // 2. çŠ¶æ…‹æ›´æ–°
                const myPlayer = currentGame.players[myPlayerKey];
                const opponentPlayerKey = myPlayerKey === 'creator' ? 'joiner' : 'creator';
                const opponentPlayer = currentGame.players[opponentPlayerKey];
                
                myPlayer.selectedButtons.push(buttonIndex);
                myPlayer.isTurn = false;

                if (isShock) {
                    // æ„Ÿé›»ï¼ã‚²ãƒ¼ãƒ çµ‚äº†
                    myPlayer.isShocked = true;
                    currentGame.status = 'FINISHED';
                    
                    // ãƒã‚¤ãƒ³ãƒˆå¢—æ¸›ã‚’è¨ˆç®—
                    myPlayer.pointsChange = -currentGame.betPoints; // è² ã‘
                    opponentPlayer.pointsChange = currentGame.betPoints; // å‹ã¡
                    
                    showMessage($gameMessagePlay, `âš¡ï¸ ${myPlayer.name} ãŒæ„Ÿé›»ï¼ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ âš¡ï¸`, 'error');

                } else {
                    // ã‚»ãƒ¼ãƒ•ï¼ã‚¿ãƒ¼ãƒ³äº¤ä»£
                    opponentPlayer.isTurn = true;
                    currentGame.currentTurn++;
                    showMessage($gameMessagePlay, 'ã‚»ãƒ¼ãƒ•ï¼ã‚¿ãƒ¼ãƒ³ãŒç›¸æ‰‹ã«ç§»ã‚Šã¾ã—ãŸã€‚', 'success');
                }

                // 3. ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
                const allPvpData = await fetchPvpData();
                const gameIndex = allPvpData.pvp_games.findIndex(g => g.gameCode === currentGame.gameCode);
                
                if (gameIndex !== -1) {
                    // æœ€æ–°ã®çŠ¶æ…‹ã«ä¸Šæ›¸ã
                    allPvpData.pvp_games[gameIndex] = currentGame;
                    const updateResult = await updatePvpData(allPvpData);

                    if (updateResult.status !== 'success') {
                        throw new Error(updateResult.message);
                    }
                } else {
                     throw new Error('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                }
                
                // 4. ç”»é¢å†æç”»ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãŒã™ãã«æ¬¡ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚€ã¯ãšã ãŒã€å³åº§ã«æ›´æ–°ï¼‰
                renderGame();

            } catch (error) {
                showMessage($gameMessagePlay, `ãƒœã‚¿ãƒ³æŠ¼ä¸‹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ã™ã‚‹ã‹ã€ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹ãªã©ãŒå¿…è¦
                document.querySelectorAll('.game-button').forEach(btn => btn.disabled = false);
            }
        }
        
        /**
         * ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®çµæœè¡¨ç¤ºã¨ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
         */
        async function displayGameResult() {
            const creator = currentGame.players.creator;
            const joiner = currentGame.players.joiner;
            
            let resultMessage = '';
            
            if (creator.isShocked) {
                resultMessage = `<p>æ•—è€…: <strong style="color: #F44336;">${creator.name} (ãƒ›ã‚¹ãƒˆ)</strong> âš¡ï¸</p>`;
                resultMessage += `<p>å‹è€…: <strong style="color: #4CAF50;">${joiner.name} (ã‚²ã‚¹ãƒˆ)</strong> ğŸ‰</p>`;
            } else if (joiner.isShocked) {
                resultMessage = `<p>æ•—è€…: <strong style="color: #F44336;">${joiner.name} (ã‚²ã‚¹ãƒˆ)</strong> âš¡ï¸</p>`;
                resultMessage += `<p>å‹è€…: <strong style="color: #4CAF50;">${creator.name} (ãƒ›ã‚¹ãƒˆ)</strong> ğŸ‰</p>`;
            } else {
                resultMessage = `<p>ã‚²ãƒ¼ãƒ ã¯äºˆæœŸã›ã¬çŠ¶æ…‹ã§çµ‚äº†ã—ã¾ã—ãŸã€‚</p>`;
            }
            
            resultMessage += `<p>ãƒã‚¤ãƒ³ãƒˆå¤‰å‹•: ${creator.name}: ${creator.pointsChange} P, ${joiner.name}: ${joiner.pointsChange} P</p>`;
            resultMessage += '<p style="font-weight: bold; margin-top: 10px;">ãƒã‚¤ãƒ³ãƒˆã¯è‡ªå‹•ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>';

            showMessage($gameMessagePlay, resultMessage, 'info');
            
            // ãƒã‚¤ãƒ³ãƒˆåæ˜ å‡¦ç†
            await updateRankingScores(creator, joiner);
        }
        
        /**
         * ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         * @param {object} creator - ãƒ›ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€çµ‚çŠ¶æ…‹
         * @param {object} joiner - ã‚²ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€çµ‚çŠ¶æ…‹
         */
        async function updateRankingScores(creator, joiner) {
            try {
                const allData = await fetchAllData();
                let isUpdated = false;
                
                [creator, joiner].forEach(player => {
                    if (player.pointsChange !== 0) {
                        const scoreIndex = allData.scores.findIndex(s => s.name === player.name);
                        if (scoreIndex !== -1) {
                            allData.scores[scoreIndex].score += player.pointsChange;
                            isUpdated = true;
                            console.log(`[POINT UPDATE] ${player.name}: ${player.pointsChange} P åæ˜ æ¸ˆã¿`);
                        }
                    }
                });

                if (isUpdated) {
                    const updateResult = await updateAllData(allData);
                    if (updateResult.status !== 'success') {
                        throw new Error(updateResult.message);
                    }
                    showMessage($gameMessagePlay, 'ãƒã‚¤ãƒ³ãƒˆå¤‰å‹•ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    showMessage($gameMessagePlay, 'ãƒã‚¤ãƒ³ãƒˆã®å¤‰å‹•ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'info');
                }

            } catch (error) {
                 showMessage($systemError, `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¸ã®ãƒã‚¤ãƒ³ãƒˆåæ˜ ä¸­ã«é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }


        // --- ãƒãƒ¼ãƒªãƒ³ã‚°å‡¦ç† ---
        
        /**
         * å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã¨ã€ä½œæˆã—ãŸã‚²ãƒ¼ãƒ ã®å‚åŠ çŠ¶æ³ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹
         * @param {string} [createdCode] - ä½œæˆã—ãŸã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰
         */
        function startPollingWaitingGames(createdCode) {
            // æ—¢ã«ãƒãƒ¼ãƒªãƒ³ã‚°ãŒé–‹å§‹ã•ã‚Œã¦ã„ãŸã‚‰åœæ­¢
            if (pollingInterval) clearInterval(pollingInterval);
            
            const poll = async () => {
                const allPvpData = await fetchPvpData();
                const pvpGames = allPvpData.pvp_games;
                
                // å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆæ›´æ–°
                renderWaitingGamesList(pvpGames);
                
                // ä½œæˆã—ãŸã‚²ãƒ¼ãƒ ã®å‚åŠ è€…ãƒã‚§ãƒƒã‚¯
                if (createdCode) {
                    const myGame = pvpGames.find(g => g.gameCode === createdCode);
                    if (myGame && myGame.status === 'PLAYING' && myGame.players.joiner) {
                        // å‚åŠ è€…ãŒè¦‹ã¤ã‹ã£ãŸï¼
                        currentGame = myGame;
                        localPlayer.role = 'creator';
                        showMessage($gameMessage, `ã‚²ã‚¹ãƒˆ <strong style="color:#2196F3;">${myGame.players.joiner.name}</strong> ãŒå‚åŠ ã—ã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ é–‹å§‹ï¼`, 'success');
                        switchScreen('play'); // ã‚²ãƒ¼ãƒ ç”»é¢ã¸
                        return; // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
                    }
                }
            };
            
            poll(); // åˆå›å®Ÿè¡Œ
            pollingInterval = setInterval(poll, POLLING_RATE);
        }

        /**
         * é€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function startPollingGameStatus() {
            if (pollingInterval) clearInterval(pollingInterval);
            
            const poll = async () => {
                if (!currentGame) return;

                const allPvpData = await fetchPvpData();
                const updatedGame = allPvpData.pvp_games.find(g => g.gameCode === currentGame.gameCode);
                
                if (updatedGame) {
                    const myPlayerKey = localPlayer.role;
                    // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¾ãŸã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿æ›´æ–°
                    if (updatedGame.status !== currentGame.status || (updatedGame.players[myPlayerKey] && updatedGame.players[myPlayerKey].isTurn !== currentGame.players[myPlayerKey].isTurn)) {
                        currentGame = updatedGame;
                        renderGame();
                    }
                } else {
                    // ã‚²ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚ŒãŸ
                    showMessage($systemError, 'å¯¾æˆ¦ä¸­ã®ã‚²ãƒ¼ãƒ ãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚', 'error');
                    currentGame = null;
                    switchScreen('setup');
                }
                
                // ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸã‚‰ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
                if (currentGame && currentGame.status === 'FINISHED') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            };

            poll(); // åˆå›å®Ÿè¡Œ
            pollingInterval = setInterval(poll, POLLING_RATE);
        }


        // --- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---
        window.onload = async () => {
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®š
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            
            await loadPlayerList();
            
            // å¸¸ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰é–‹å§‹
            switchScreen('login');
        };

        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ãã«ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
