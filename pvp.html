<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈõªÊ∞óÊ§ÖÂ≠êPVP</title>
    <style>
        /* --- ÈõªÊ∞ó„Éª„Çµ„Ç§„Éê„Éº„Éë„É≥„ÇØ Â§âÊï∞ÂÆöÁæ© --- */
        :root {
            --color-bg: #050a14;          /* Ê∑±ÂÆáÂÆô„Éª„ÉÄ„Éº„ÇØ„Éç„Ç§„Éì„Éº */
            --color-panel: rgba(16, 24, 48, 0.95); /* „Éë„Éç„É´ËÉåÊôØ */
            --color-primary: #00f2ff;     /* „Éç„Ç™„É≥„Ç∑„Ç¢„É≥ÔºàÈõªÊíÉÔºâ */
            --color-accent: #ffcc00;      /* „Ç®„É¨„ÇØ„Éà„É™„ÉÉ„ÇØ„Ç§„Ç®„É≠„ÉºÔºàË≠¶ÂëäÔºâ */
            --color-text: #e0e6ed;        /* „ÉÜ„Ç≠„Çπ„Éà„Ç´„É©„Éº */
            --color-light: #ffffff;
            --color-border: #1e3a5f;
            --color-error: #ff0055;       /* „Éç„Ç™„É≥„É¨„ÉÉ„ÉâÔºàÈÅéË≤†Ëç∑Ôºâ */
            --color-success: #39ff14;     /* „Éç„Ç™„É≥„Ç∞„É™„Éº„É≥ÔºàÈÄöÈõªÔºâ */
            --color-info: #70a1ff;
            --font-primary: 'Exo 2', 'Hiragino Sans', 'Meiryo', sans-serif;
            --glow-primary: 0 0 10px rgba(0, 242, 255, 0.5), 0 0 20px rgba(0, 242, 255, 0.2);
            --glow-accent: 0 0 15px rgba(255, 204, 0, 0.4);
        }

        /* --- „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ --- */
        @keyframes electric-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
            92% { opacity: 0.9; }
            95% { opacity: 0.5; }
            98% { opacity: 0.9; }
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes thunder-glow {
            0%, 100% { box-shadow: var(--glow-primary); }
            50% { box-shadow: 0 0 25px rgba(0, 242, 255, 0.8), 0 0 40px rgba(0, 242, 255, 0.4); }
        }

        /* --- Âü∫Êú¨„Çπ„Çø„Ç§„É´ --- */
        body {
            font-family: var(--font-primary);
            background-color: var(--color-bg);
            /* ÂõûË∑ØÂõ≥„ÅÆ„Çà„ÅÜ„Å™ËÉåÊôØ„Éë„Çø„Éº„É≥ */
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            background-attachment: fixed;
            color: var(--color-text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Ëµ∞ÊüªÁ∑ö„Ç®„Éï„Çß„ÇØ„Éà */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }

        header {
            background-color: rgba(5, 10, 20, 0.8);
            color: var(--color-primary);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 2px solid var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 2.2em;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-weight: 900;
            text-shadow: var(--glow-primary);
            animation: electric-flicker 4s linear infinite;
        }

        main {
            max-width: 800px;
            margin: 30px auto;
            padding: 25px;
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.6s ease-out forwards;
        }

        .tool-box {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 22px;
            margin-bottom: 30px;
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-primary);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .tool-box:hover {
            border-color: var(--color-primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }

        h2, h3, h4, h5 {
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0;
        }

        /* --- „Éú„Çø„É≥ --- */
        .action-button, button[type="submit"] {
            background: #001a33;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            padding: 16px 20px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-top: 15px;
            font-weight: bold;
            font-size: 1rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: inset 0 0 10px rgba(0, 242, 255, 0.2);
        }

        .action-button:hover:not(:disabled), button[type="submit"]:hover {
            background: var(--color-primary);
            color: var(--color-bg);
            box-shadow: 0 0 20px var(--color-primary);
            transform: translateY(-1px);
        }

        .action-button:disabled {
            border-color: #333;
            color: #555;
            cursor: not-allowed;
            background: #111;
            box-shadow: none;
        }

        .secondary-button {
            border-color: var(--color-accent) !important;
            color: var(--color-accent) !important;
            box-shadow: inset 0 0 10px rgba(255, 204, 0, 0.1) !important;
        }

        .secondary-button:hover:not(:disabled) {
            background: var(--color-accent) !important;
            color: var(--color-bg) !important;
            box-shadow: 0 0 20px var(--color-accent) !important;
        }

        /* --- „Éï„Ç©„Éº„É† --- */
        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            background: #000;
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            padding: 14px;
            margin-top: 5px;
            border-radius: 4px;
            outline: none;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
        }

        .hidden { display: none !important; }
        .mb-5 { margin-bottom: 5px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-10 { margin-top: 10px; }
        .text-small { font-size: 0.9em; opacity: 0.8; }
        .text-center { text-align: center; }
        .flex-around { display: flex; justify-content: space-around; gap: 15px; }
        .flex-1 { flex: 1; }
        .w-auto { width: auto; }
        .w-full { width: 100%; }

        /* --- PVP„Ç¢„É™„Éº„Éä --- */
        .chair-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .chair-button {
            padding: 20px 10px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            background: #0a1120;
            color: var(--color-info);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-shadow: 0 0 5px rgba(112, 161, 255, 0.5);
        }

        .chair-button:hover:not(:disabled) {
            border-color: var(--color-primary);
            color: var(--color-primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
        }

        .chosen-chair {
            background-color: #1e3a5f !important;
            border-color: var(--color-primary) !important;
            color: var(--color-primary) !important;
            opacity: 0.5;
        }

        .shocked {
            background-color: #330011 !important;
            border-color: var(--color-error) !important;
            color: var(--color-error) !important;
            box-shadow: 0 0 20px var(--color-error) !important;
            animation: electric-flicker 0.2s infinite;
        }
        
        .player-info-card {
            padding: 20px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--color-border);
            position: relative;
        }

        .current-player {
            border-color: var(--color-primary);
            box-shadow: inset 0 0 15px rgba(0, 242, 255, 0.2), 0 0 15px rgba(0, 242, 255, 0.3);
            animation: thunder-glow 3s infinite;
        }

        .shock-counter { 
            color: var(--color-error); 
            font-size: 1.2em; 
            text-shadow: 0 0 8px var(--color-error);
        }

        .turn-indicator {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--color-accent);
            margin: 15px 0;
            text-shadow: var(--glow-accent);
        }

        /* --- „Éï„ÉÉ„Çø„Éº --- */
        footer {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background-color: #050a14;
            padding: 15px 0;
            z-index: 1000;
            border-top: 2px solid var(--color-primary);
            box-shadow: 0 -5px 20px rgba(0, 242, 255, 0.2);
        }

        .footer-nav { display: flex; justify-content: center; max-width: 800px; margin: 0 auto; }
        .footer-nav .input-link {
            flex-grow: 1;
            text-align: center;
            margin: 0 10px;
            padding: 10px;
            color: var(--color-primary);
            background-color: rgba(0, 242, 255, 0.05);
            border: 1px solid rgba(0, 242, 255, 0.2);
            text-decoration: none;
            font-weight: bold;
            font-size: 0.85em;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .footer-nav .input-link:hover {
            background-color: var(--color-primary);
            color: var(--color-bg);
            box-shadow: 0 0 15px var(--color-primary);
        }

        #result-message {
            color: var(--color-accent);
        }
        
        .error { color: var(--color-error); }
    </style>
</head>
<body>
    <header>
        <h1> ÈõªÊ∞óÊ§ÖÂ≠êPVP </h1>
    </header>

    <main id="main-content" class="pvp-main">
        <section id="auth-section">
            <h2>SYSTEM LOGIN</h2>
            <form id="auth-form">
                <div class="form-group">
                    <label for="username">USER NAME:</label>
                    <input type="text" id="username" required placeholder="Enter login name...">
                </div>
                <div class="form-group">
                    <label for="password">PASSWORD:</label>
                    <input type="password" id="password" required placeholder="Enter password...">
                </div>
                <button type="submit">ACCESS GRANTED</button>
            </form>
            <p id="auth-message" class="hidden"></p>
        </section>

        <section id="pvp-lobby" class="hidden">
            <h3 class="mb-5">WELCOME, <span id="authenticated-user-name"></span></h3>
            <p class="text-small mb-20">POWER RESERVE: <strong id="current-score" style="color: var(--color-primary);"></strong> P</p>
            <button type="button" id="logout-button" class="action-button secondary-button w-auto mb-20">TERMINATE SESSION</button>

            <div id="room-management" class="tool-box">
                <h4>üö™ CREATE NEW NODE</h4>
                <p id="create-room-restriction-message" class="error hidden room-restriction-alert">HIGH-LEVEL ACCESS REQUIRED.</p>
                <form id="create-room-form" class="mb-20">
                    <h5 class="mb-5">üèÜ WIN PRIORITY (P)</h5>
                    <div class="point-config-grid">
                        <div class="form-group">
                            <input type="number" id="win-points" step="0.1" value="10.0" required>
                        </div>
                    </div>
                    <button type="submit" class="action-button w-full">INITIALIZE ROOM</button>
                    <p id="create-room-message" class="hidden"></p>
                </form>
                <form id="join-room-form">
                    <div class="form-group">
                        <label for="room-code">NODE CODE (6 DIGITS):</label>
                        <input type="text" id="room-code" maxlength="6" required placeholder="000000">
                    </div>
                    <button type="submit" class="action-button w-full" style="border-color: var(--color-info); color: var(--color-info);">CONNECT TO NODE</button>
                    <p id="join-room-message" class="hidden"></p>
                </form>
            </div>
            
            <div id="available-games-container" class="tool-box">
                <h4>ü§ù ACTIVE NODES</h4>
                <div id="available-game-list"><p>Scanning...</p></div>
            </div>
        </section>

        <section id="game-arena" class="hidden">
            <h2 id="game-title">‚ö° CURRENTLY CHARGING ‚ö°</h2>
            <div id="last-result-display" class="tool-box hidden mb-20" style="background-color: rgba(0,0,0,0.6); border-color: var(--color-accent);">
                <p id="result-message" class="text-small font-bold" style="margin: 0;"></p>
            </div>
            <div class="flex-around mb-10">
                <div id="player-a-card" class="player-info-card flex-1"></div>
                <div id="player-b-card" class="player-info-card flex-1"></div>
            </div>
            <p id="turn-display" class="turn-indicator"></p>
            <p id="round-display" class="text-center mb-10 text-small">ROUND: <strong id="current-round">1</strong> / 6</p>

            <div class="tool-box p-10">
                <h3 class="text-small mt-0 mb-10">SELECT TARGET CHAIR</h3>
                <form id="action-form">
                    <div id="chair-container" class="chair-grid"></div>
                    <p id="chair-action-message" class="hidden"></p>
                </form>
                <div class="mt-10">
                    <button id="leave-game-button" class="action-button secondary-button">ABORT MISSION</button>
                </div>
            </div>
            <p id="game-message" class="hidden"></p>
        </section>
    </main>

    <script src="assets/js/common.js"></script>
    <script>
        const AUTH_SECTION = document.getElementById('auth-section');
        const PVP_LOBBY = document.getElementById('pvp-lobby');
        const GAME_ARENA = document.getElementById('game-arena');
        const AUTH_FORM = document.getElementById('auth-form');
        const AUTH_MESSAGE = document.getElementById('auth-message');
        const LOGOUT_BUTTON = document.getElementById('logout-button');
        const AUTHENTICATED_USER_NAME = document.getElementById('authenticated-user-name');
        const CURRENT_SCORE_ELEMENT = document.getElementById('current-score');
        const AVAILABLE_GAME_LIST = document.getElementById('available-game-list');
        const CREATE_ROOM_FORM = document.getElementById('create-room-form');
        const JOIN_ROOM_FORM = document.getElementById('join-room-form');
        const CHAIR_CONTAINER = document.getElementById('chair-container');
        const ACTION_FORM = document.getElementById('action-form');
        const TURN_DISPLAY = document.getElementById('turn-display');
        const ROUND_DISPLAY = document.getElementById('round-display');
        const LAST_RESULT_DISPLAY = document.getElementById('last-result-display');
        const RESULT_MESSAGE = document.getElementById('result-message');
        const PLAYER_A_CARD = document.getElementById('player-a-card');
        const PLAYER_B_CARD = document.getElementById('player-b-card');
        const CREATE_ROOM_RESTRICTION_MESSAGE = document.getElementById('create-room-restriction-message');
        const ALLOWED_STATUSES = ['premium', 'luxury'];

        let authenticatedUser = null; 
        let currentGameState = null;
        let pollingInterval = null;
        const POLLING_RATE = 3000;

        async function attemptLogin(username, password, isAuto = false) {
            if (!isAuto) showMessage(AUTH_MESSAGE, 'AUTHENTICATING...', 'info');
            const pvpData = await fetchPvpData(username);
            const allScores = pvpData.allScores;
            const user = allScores.find(p => p.name === username && p.pass === password);
            if (user) {
                authenticatedUser = user; 
                authenticatedUser.status = user.status || 'none';
                localStorage.setItem('pvpAuthUsername', username);
                localStorage.setItem('pvpAuthPassword', password);
                AUTH_SECTION.classList.add('hidden');
                PVP_LOBBY.classList.remove('hidden');
                initializeLobby();
                startPolling();
                return true;
            } else {
                if (isAuto) {
                    localStorage.removeItem('pvpAuthUsername');
                    localStorage.removeItem('pvpAuthPassword');
                } else {
                    showMessage(AUTH_MESSAGE, '‚ùå ACCESS DENIED: INVALID CREDENTIALS.', 'error');
                }
                return false;
            }
        }

        async function autoLogin() {
            const username = localStorage.getItem('pvpAuthUsername');
            const password = localStorage.getItem('pvpAuthPassword');
            if (username && password) await attemptLogin(username, password, true);
        }

        function handleLogout() {
            if (pollingInterval) clearInterval(pollingInterval);
            localStorage.removeItem('pvpAuthUsername');
            localStorage.removeItem('pvpAuthPassword');
            authenticatedUser = null;
            currentGameState = null;
            AUTH_SECTION.classList.remove('hidden');
            PVP_LOBBY.classList.add('hidden');
            GAME_ARENA.classList.add('hidden');
            AUTH_FORM.reset();
            showMessage(AUTH_MESSAGE, 'üëã SESSION TERMINATED.', 'info');
        }

        function initializeLobby() {
            if (!authenticatedUser) return;
            AUTHENTICATED_USER_NAME.textContent = authenticatedUser.name;
            CURRENT_SCORE_ELEMENT.textContent = authenticatedUser.score ? authenticatedUser.score.toFixed(1) : '0.0';
            const canCreateRoom = ALLOWED_STATUSES.includes(authenticatedUser.status);
            if (canCreateRoom) {
                CREATE_ROOM_FORM.style.display = 'block';
                CREATE_ROOM_RESTRICTION_MESSAGE.classList.add('hidden');
            } else {
                CREATE_ROOM_FORM.style.display = 'none';
                CREATE_ROOM_RESTRICTION_MESSAGE.classList.remove('hidden');
            }
            if (currentGameState && currentGameState.status !== 'WAITING_JOIN' && currentGameState.playerB) {
                PVP_LOBBY.classList.add('hidden');
                GAME_ARENA.classList.remove('hidden');
                renderGameArena(currentGameState);
            }
        }

        async function fetchAndUpdatePvpData() {
            if (!authenticatedUser) return;
            const data = await fetchPvpData(authenticatedUser.name);
            const myCurrentScoreData = data.allScores.find(p => p.name === authenticatedUser.name);
            if (myCurrentScoreData) {
                authenticatedUser.score = myCurrentScoreData.score;
                authenticatedUser.status = myCurrentScoreData.status || 'none';
                CURRENT_SCORE_ELEMENT.textContent = myCurrentScoreData.score.toFixed(1);
            }
            const myGame = data.currentGames.filter(g => g.status !== 'DELETED').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0]; 
            if (myGame) {
                const isGameFinished = myGame.status === 'FINISHED';
                if (!currentGameState || myGame.actionToken !== currentGameState.actionToken || myGame.status !== currentGameState.status || isGameFinished) {
                    currentGameState = myGame;
                    PVP_LOBBY.classList.add('hidden');
                    GAME_ARENA.classList.remove('hidden');
                    renderGameArena(currentGameState);
                }
            } else {
                if (currentGameState) {
                    currentGameState = null;
                    GAME_ARENA.classList.add('hidden');
                    PVP_LOBBY.classList.remove('hidden');
                    showMessage(document.getElementById('create-room-message'), '‚úÖ MISSION COMPLETE. RETURNING TO LOBBY.', 'success');
                }
                renderLobbyLists([], data.availableGames);
                initializeLobby();
            }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            fetchAndUpdatePvpData();
            pollingInterval = setInterval(fetchAndUpdatePvpData, POLLING_RATE);
        }

        function renderLobbyLists(finishedGames, availableGames) {
            AVAILABLE_GAME_LIST.innerHTML = availableGames.map(g => {
                const losePoints = -g.winPoints;
                const forfeitPoints = losePoints * 2;
                return `<div class="tool-box" style="margin-bottom: 10px; padding: 10px;">
                            <p style="margin: 0; font-weight: bold;">NODE OWNER: ${g.playerA}</p>
                            <p style="margin: 0; font-size: 0.8em; color: var(--color-info);">
                                üèÜ WIN: +${g.winPoints.toFixed(1)} P / üò≠ LOSE: ${losePoints.toFixed(1)} P / üèÉ FORFEIT: ${forfeitPoints.toFixed(1)} P
                            </p>
                            <button class="action-button join-available-button" data-room-code="${g.roomCode}" style="width: auto; margin-top: 5px;">
                                CONNECT (${g.roomCode})
                            </button>
                        </div>`;
            }).join('');
            if (availableGames.length === 0) AVAILABLE_GAME_LIST.innerHTML = '<p>NO ACTIVE NODES FOUND.</p>';
            document.querySelectorAll('.join-available-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roomCode = btn.dataset.roomCode;
                    document.getElementById('room-code').value = roomCode;
                    JOIN_ROOM_FORM.dispatchEvent(new Event('submit'));
                });
            });
        }

        function renderGameArena(game) {
            if (!game) return;
            const myName = authenticatedUser.name;
            const leaveButton = document.getElementById('leave-game-button');
            const renderPlayerCard = (player, score, shockCount, isCurrentPlayer) => {
                const shockText = '‚ö°'.repeat(shockCount);
                return `
                    <h4 style="margin-top: 0; display: flex; justify-content: space-between; font-size: 0.9em;">
                        ${player} ${isCurrentPlayer ? '(YOU)' : ''}
                        <span class="shock-counter">${shockText}</span>
                    </h4>
                    <p style="margin: 0; font-size: 0.8em;">POWER: <strong style="color: var(--color-primary);">${score.toFixed(1)} P</strong></p>
                `;
            };
            PLAYER_A_CARD.innerHTML = renderPlayerCard(game.playerA, game.scoreA, game.shockCountA, game.playerA === myName);
            PLAYER_B_CARD.innerHTML = game.playerB 
                ? renderPlayerCard(game.playerB, game.scoreB, game.shockCountB, game.playerB === myName)
                : '<h4>WAITING FOR CONNECTION...</h4>';
            
            const isFinished = game.status === 'FINISHED';
            PLAYER_A_CARD.classList.toggle('current-player', !isFinished && game.playerA === game.nextActionPlayer);
            PLAYER_B_CARD.classList.toggle('current-player', !isFinished && game.playerB === game.nextActionPlayer);

            const currentRound = Math.min(Math.ceil(game.round / 2), 6);
            document.getElementById('current-round').textContent = `${currentRound}/6`;
            
            let turnText = '';
            if (game.status === 'WAITING_JOIN') {
                turnText = `NODE CODE: ${game.roomCode}. WAITING FOR OPPONENT (${game.playerB || '... '}).`;
                CHAIR_CONTAINER.innerHTML = '';
                leaveButton.textContent = 'DELETE NODE';
                leaveButton.dataset.action = 'delete';
            } else if (isFinished) {
                let myPointChange = 0;
                let myResultText = '';
                if (game.winner === 'DRAW') {
                    myResultText = 'ü§ù DRAW'; myPointChange = 0;
                } else if (game.winner === myName) {
                    myResultText = 'üèÜ VICTORIOUS'; myPointChange = game.winPoints;
                } else {
                    myResultText = 'üò≠ DEFEATED'; myPointChange = game.losePoints; 
                }
                const finalMessage = game.winner === 'DRAW' 
                    ? `<span style="color: var(--color-info);">NODE TERMINATED: DRAW. FINAL SCORE ${game.scoreA.toFixed(1)}P vs ${game.scoreB.toFixed(1)}P.</span>`
                    : `<span style="color: ${game.winner === myName ? 'var(--color-success)' : 'var(--color-error)'};">
                        ${game.winner} IS DOMINANT! POWER CHANGE: **${myPointChange > 0 ? '+' : ''}${myPointChange.toFixed(1)} P**
                    </span>`;
                turnText = finalMessage;
                CHAIR_CONTAINER.innerHTML = '<p style="text-align: center; font-size: 1.2em; font-weight: bold; color: var(--color-primary);">CONNECTION TERMINATED.</p>';
                leaveButton.textContent = 'RETURN TO LOBBY (CLEAN LOG)';
                leaveButton.dataset.action = 'delete'; 
            } else if (game.nextActionPlayer === myName) {
                const isAttackerPhase = game.status === 'WAITING_A' || game.status === 'WAITING_B';
                turnText = isAttackerPhase ? '‚ö° YOUR TURN: SET VOLTAGE TO TARGET.' : 'ü™ë YOUR TURN: SELECT A CHAIR TO OCCUPY.';
                renderChairButtons(game.publicChairs, isAttackerPhase, game.gameId, game.actionToken);
                CHAIR_CONTAINER.classList.remove('hidden');
                leaveButton.textContent = 'ABORT (FORFEIT)';
                leaveButton.dataset.action = 'forfeit';
                leaveButton.disabled = false;
            } else {
                turnText = `WAITING FOR OPPONENT ACTION (${game.nextActionPlayer})...`;
                CHAIR_CONTAINER.innerHTML = '<p style="text-align: center; color: var(--color-border);">SYNCHRONIZING...</p>';
                leaveButton.textContent = 'ABORT (FORFEIT)';
                leaveButton.dataset.action = 'forfeit';
                leaveButton.disabled = false;
            }
            TURN_DISPLAY.innerHTML = turnText; 

            if (game.lastResult) {
                LAST_RESULT_DISPLAY.classList.remove('hidden');
                const lastActionRound = Math.ceil((game.round - 1) / 2);
                let message = `${game.lastResult.player} AT ROUND ${lastActionRound} CHOSE CHAIR ${game.lastResult.points > 0 ? game.lastResult.points : '??'}...`;
                if (game.lastResult.result === 'SHOCK') {
                    message += ` ‚ö° VOLTAGE OVERLOAD! POWER RESET.`;
                } else {
                    message += ` ‚úÖ SUCCESS. +${game.lastResult.points} P ACQUIRED.`;
                }
                RESULT_MESSAGE.textContent = message;
            } else {
                LAST_RESULT_DISPLAY.classList.add('hidden');
            }
        }

        function renderChairButtons(chairs, isAttackerPhase, gameId, actionToken) {
            CHAIR_CONTAINER.innerHTML = '';
            const isMyTurn = currentGameState && currentGameState.nextActionPlayer === authenticatedUser.name;
            chairs.forEach(chair => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'chair-button';
                button.dataset.chairId = chair.id;
                button.textContent = `${chair.id} V`;
                if (!chair.available) {
                    button.disabled = true; button.classList.add('chosen-chair');
                } else if (isMyTurn) {
                    if (isAttackerPhase) button.addEventListener('click', () => handleShockAction(gameId, actionToken, chair.id));
                    else button.addEventListener('click', () => handleChooseAction(gameId, actionToken, chair.id));
                }
                if (!isMyTurn || !chair.available) button.disabled = true;
                CHAIR_CONTAINER.appendChild(button);
            });
        }

        CREATE_ROOM_FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('create-room-message');
            const rawWinPoints = parseFloat(document.getElementById('win-points').value);
            const winPoints = parseFloat(rawWinPoints.toFixed(1));
            const losePoints = parseFloat((-winPoints).toFixed(1));
            const forfeitPoints = parseFloat((losePoints * 2).toFixed(1));
            showMessage(messageEl, 'INITIALIZING NODE...', 'info');
            const response = await sendPvpAction({
                action: 'create', player: authenticatedUser.name,
                pointsConfig: { winPoints, losePoints, forfeitPoints }
            });
            if (response.status === 'success') showMessage(messageEl, `‚úÖ NODE ACTIVE. CODE: ${response.gameData.roomCode}`, 'success');
            else showMessage(messageEl, `‚ùå ERROR: ${response.message}`, 'error');
        });

        JOIN_ROOM_FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('join-room-message');
            const roomCode = document.getElementById('room-code').value.toUpperCase().trim();
            showMessage(messageEl, `CONNECTING TO ${roomCode}...`, 'info');
            const pvpData = await fetchPvpData(authenticatedUser.name);
            const targetGame = pvpData.availableGames.find(g => g.roomCode === roomCode);
            if (!targetGame) {
                showMessage(messageEl, '‚ùå NODE NOT FOUND OR FULL.', 'error'); return;
            }
            const response = await sendPvpAction({
                action: 'join', gameId: targetGame.gameId, roomCode, player: authenticatedUser.name, actionToken: targetGame.actionToken
            });
            if (response.status === 'success') {
                showMessage(messageEl, `‚úÖ CONNECTED TO ${roomCode}.`, 'success'); JOIN_ROOM_FORM.reset();
            } else showMessage(messageEl, `‚ùå ERROR: ${response.message}`, 'error');
        });

        async function handleShockAction(gameId, actionToken, chairId) {
            if (!window.confirm(`SET VOLTAGE TO CHAIR ${chairId}?`)) return;
            const messageEl = document.getElementById('chair-action-message');
            showMessage(messageEl, `‚ö° CHARGING CHAIR ${chairId}...`, 'info');
            CHAIR_CONTAINER.querySelectorAll('button').forEach(btn => btn.disabled = true);
            const response = await sendPvpAction({ action: 'setShockChair', gameId, player: authenticatedUser.name, input: chairId, actionToken });
            if (response.status === 'success') {
                if (response.gameData && response.gameData.status === 'FINISHED') {
                    currentGameState = response.gameData; renderGameArena(currentGameState);
                }
                showMessage(messageEl, `‚úÖ VOLTAGE SET.`, 'success');
                currentGameState.actionToken = response.actionToken;
            } else {
                showMessage(messageEl, `‚ùå ERROR: ${response.message}`, 'error');
                CHAIR_CONTAINER.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        }

        async function handleChooseAction(gameId, actionToken, chairId) {
            if (!window.confirm(`OCCUPY CHAIR ${chairId}?`)) return;
            const messageEl = document.getElementById('chair-action-message');
            showMessage(messageEl, `ü™ë ATTEMPTING TO OCCUPY ${chairId}...`, 'info');
            CHAIR_CONTAINER.querySelectorAll('button').forEach(btn => btn.disabled = true);
            const response = await sendPvpAction({ action: 'chooseChair', gameId, player: authenticatedUser.name, input: chairId, actionToken });
            if (response.status === 'success') {
                const result = response.shockResult.result;
                if (result === 'SHOCK') showMessage(messageEl, `‚ùå VOLTAGE OVERLOAD!`, 'error');
                else showMessage(messageEl, `‚úÖ CLEAR.`, 'success');
                currentGameState.actionToken = response.actionToken;
                if (response.gameData) {
                    currentGameState = response.gameData; renderGameArena(currentGameState);
                }
            } else {
                showMessage(messageEl, `‚ùå ERROR: ${response.message}`, 'error');
                CHAIR_CONTAINER.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        }

        document.getElementById('leave-game-button').addEventListener('click', async (e) => {
            if (!currentGameState || !authenticatedUser) { fetchAndUpdatePvpData(); return; }
            const action = e.target.dataset.action;
            if (action === 'delete' && currentGameState.status !== 'WAITING_JOIN' && !window.confirm('TERMINATE NODE?')) return;
            if (action === 'forfeit' && !window.confirm('ABORT MISSION? THIS WILL RESULT IN DEFEAT.')) return;
            const messageEl = document.getElementById('game-message');
            showMessage(messageEl, 'TERMINATING...', 'info');
            const response = await sendPvpAction({ action, gameId: currentGameState.gameId, player: authenticatedUser.name, actionToken: currentGameState.actionToken });
            if (response.status === 'success') {
                if (action === 'delete') {
                    currentGameState = null; fetchAndUpdatePvpData();
                } else if (action === 'forfeit') {
                    currentGameState = response.gameData; renderGameArena(currentGameState);
                }
            }
        });

        AUTH_FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            await attemptLogin(document.getElementById('username').value.trim(), document.getElementById('password').value.trim(), false);
        });
        LOGOUT_BUTTON.addEventListener('click', handleLogout);
        window.onload = autoLogin;
    </script>
</body>
</html>
