<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»æ°—æ¤…å­ã‚²ãƒ¼ãƒ  (PvP)</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* PvPãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pvp-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            background-color: var(--color-background-secondary);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .login-select-area {
            text-align: center;
            padding: 20px;
            border: 1px dashed var(--color-text);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            background-color: var(--color-background-primary);
        }
        .game-button {
            padding: 20px 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--color-text);
            background-color: var(--color-button-primary);
            border: 3px solid var(--color-accent);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s, box-shadow 0.15s;
            box-shadow: 0 3px 0 var(--color-accent-dark);
        }
        .game-button:hover:not(:disabled) {
            background-color: var(--color-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 0 var(--color-accent-dark);
        }
        .game-button:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 1px 0 var(--color-accent-dark);
        }
        .game-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ */
        .selected-by-creator {
            background-color: #4CAF50 !important; /* Green */
            border-color: #388E3C !important;
            color: white !important;
            box-shadow: 0 3px 0 #388E3C;
        }
        .selected-by-joiner {
            background-color: #2196F3 !important; /* Blue */
            border-color: #1976D2 !important;
            color: white !important;
            box-shadow: 0 3px 0 #1976D2;
        }
        .shocked-button {
            background-color: #F44336 !important; /* Red */
            border-color: #D32F2F !important;
            color: yellow !important;
            animation: pulse-shock 0.5s infinite alternate;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8), 0 3px 0 #D32F2F;
        }

        .current-turn {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
            text-align: center;
        }
        .my-turn {
            background-color: #e0ffe0; /* Green tint */
            color: #388E3C;
        }
        .opponent-turn {
            background-color: #e0f2ff; /* Blue tint */
            color: #1976D2;
        }
        
        .dark-mode .my-turn { background-color: #1a4d1a; color: #a5d6a7; }
        .dark-mode .opponent-turn { background-color: #1a2a4d; color: #a5c3d6; }
        .dark-mode .shocked-button { color: #ffe082 !important; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±è¡¨ç¤º */
        .player-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--color-background-primary);
        }
        .player-info div {
            flex-basis: 48%;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
        }
        .player-info .player-name-display {
            font-weight: bold;
            font-size: 1.1em;
        }
        .player-info .creator-side { border: 2px solid #4CAF50; }
        .player-info .joiner-side { border: 2px solid #2196F3; }

        /* ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å…¥åŠ›/è¡¨ç¤º */
        .code-area {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
        }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        #game-message {
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            min-height: 40px;
        }
        .hidden { display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        .dark-mode .success { background-color: #1f4427; color: #a5d6a7; }
        .dark-mode .error { background-color: #4d1c1c; color: #f8d7da; }
        .dark-mode .info { background-color: #1c364d; color: #d1ecf1; }
        
        @keyframes pulse-shock {
            from { box-shadow: 0 0 15px rgba(255, 0, 0, 0.8), 0 3px 0 #D32F2F; }
            to { box-shadow: 0 0 25px rgba(255, 100, 100, 1), 0 3px 0 #D32F2F; }
        }
    </style>
</head>
<body>
    <header>
        <h1>é›»æ°—æ¤…å­ã‚²ãƒ¼ãƒ  (PvP)</h1>
    </header>

    <main>
        <div class="pvp-container">
            <div id="login-screen">
                <h2>ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="login-select-area">
                    <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã¨**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ› -->
                    <input type="text" id="player-name-input" class="input-field" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="width: 100%; margin-bottom: 10px;">
                    
                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <input type="password" id="password-input" class="input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; margin-bottom: 10px;">
                    
                    <button id="login-button" class="action-button">ãƒ­ã‚°ã‚¤ãƒ³ & ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                    <p id="login-error" class="error hidden" style="margin-top: 10px;"></p>
                </div>
            </div>

            <div id="game-setup-screen" class="hidden">
                <h2>ğŸ•¹ï¸ ã‚²ãƒ¼ãƒ è¨­å®šãƒ»å‚åŠ </h2>
                <div id="game-message" class="info hidden"></div>

                <div class="action-section">
                    <h3>ã‚²ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ (ãƒ›ã‚¹ãƒˆ)</h3>
                    <!-- è³­ã‘ãƒã‚¤ãƒ³ãƒˆè¨­å®šã‚’ã‚²ãƒ¼ãƒ ä½œæˆæ™‚ã«ç§»å‹• -->
                    <input type="number" id="create-bet-points-input" class="input-field" placeholder="è³­ã‘ãƒã‚¤ãƒ³ãƒˆ (10Pä»¥ä¸Š)" min="10" value="100" style="width: 100%; margin-bottom: 10px;">
                    <button id="create-game-button" class="action-button">ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ</button>
                    
                    <div id="created-game-info" class="hidden info-box" style="margin-top: 10px;">
                        <p>ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰: <strong id="display-game-code" style="font-size: 1.2em; color: var(--color-accent);"></strong></p>
                        <p>è³­ã‘ãƒã‚¤ãƒ³ãƒˆ: <strong id="display-creator-bet-points"></strong> P</p>
                        <p>ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™... (ç”»é¢ã‚’é–‹ã„ãŸã¾ã¾ãŠå¾…ã¡ãã ã•ã„)</p>
                    </div>
                </div>

                <hr style="margin: 20px 0;">

                <div class="action-section">
                    <h3>ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ (ã‚²ã‚¹ãƒˆ)</h3>
                    <input type="text" id="join-code-input" class="input-field" placeholder="ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ› (ä¾‹: XYZ123)" maxlength="6">
                    <button id="join-game-button" class="action-button primary">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <div class="action-section">
                    <h3>é–‹å‚¬ä¸­ã®ã‚²ãƒ¼ãƒ </h3>
                    <div id="waiting-games-list">
                        <!-- å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        <p class="info-text">ç¾åœ¨ã€å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </div>

            <div id="game-play-screen" class="hidden">
                <div class="code-area">
                    <p>å¯¾æˆ¦ã‚³ãƒ¼ãƒ‰: <strong id="current-game-code" style="font-size: 1.5em; color: var(--color-accent);"></strong></p>
                    <p>è³­ã‘ãƒã‚¤ãƒ³ãƒˆ: <strong id="display-bet-points"></strong> P</p>
                </div>
                
                <div id="game-message-play" class="info hidden"></div>

                <div class="player-info">
                    <div class="creator-side">
                        <p>ãƒ›ã‚¹ãƒˆ:</p>
                        <p class="player-name-display" id="player-creator-name"></p>
                    </div>
                    <div class="joiner-side">
                        <p>ã‚²ã‚¹ãƒˆ:</p>
                        <p class="player-name-display" id="player-joiner-name"></p>
                    </div>
                </div>

                <div id="turn-status" class="current-turn opponent-turn">
                    <!-- ã‚¿ãƒ¼ãƒ³æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                
                <h3 style="text-align: center; margin-top: 20px;">âš¡ é›»æ°—æ¤…å­ãƒœã‚¿ãƒ³ (å…¨10å€‹) âš¡</h3>
                <div id="button-grid" class="button-grid">
                    <!-- ãƒœã‚¿ãƒ³ãŒJavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="return-to-setup" class="action-button secondary">ã‚²ãƒ¼ãƒ é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                </div>
            </div>
            
            <p id="system-error" class="error hidden" style="text-align: center; margin-top: 20px;"></p>
        </div>
    </main>

    <footer>
        <nav class="footer-nav">
            <a href="index.html" class="input-link">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
            <a href="mypage.html" class="input-link">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
            <a href="pvp.html" class="input-link current">å¯¾æˆ¦(PvP)</a> 
            <a href="master.html" class="input-link">ãƒã‚¹ã‚¿ãƒ¼</a>
        </nav>
    </footer>

    <script src="assets/js/common.js"></script>
    <script>
        // --- çŠ¶æ…‹ç®¡ç† ---
        let localPlayer = {
            name: null,
            userId: null,
            role: null, // 'creator' or 'joiner'
            betPoints: 0, // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è¨­å®šã•ã‚Œãšã€ã‚²ãƒ¼ãƒ ä½œæˆæ™‚ã«æ±ºå®šã•ã‚Œã‚‹
            passwordHash: null // èªè¨¼ç”¨ãƒãƒƒã‚·ãƒ¥
        };
        let currentGame = null;
        let pollingInterval = null;
        const POLLING_RATE = 5000; // 5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
        
        let allPlayerData = []; // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥å«ã‚€ï¼‰ã‚’ä¿å­˜

        // â˜… ä¿®æ­£: hashPasswordé–¢æ•°ã¯common.jsã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚å‰Šé™¤

        // --- DOMè¦ç´  ---
        const $loginScreen = document.getElementById('login-screen');
        const $gameSetupScreen = document.getElementById('game-setup-screen');
        const $gamePlayScreen = document.getElementById('game-play-screen');
        const $playerNameInput = document.getElementById('player-name-input');
        const $passwordInput = document.getElementById('password-input'); 
        const $createBetPointsInput = document.getElementById('create-bet-points-input');
        const $loginButton = document.getElementById('login-button');
        const $loginError = document.getElementById('login-error');
        const $gameMessage = document.getElementById('game-message');
        const $gameMessagePlay = document.getElementById('game-message-play');
        const $createGameButton = document.getElementById('create-game-button');
        const $joinCodeInput = document.getElementById('join-code-input');
        const $joinGameButton = document.getElementById('join-game-button');
        const $waitingGamesList = document.getElementById('waiting-games-list');
        const $displayGameCode = document.getElementById('display-game-code');
        const $displayCreatorBetPoints = document.getElementById('display-creator-bet-points');
        const $createdGameInfo = document.getElementById('created-game-info');
        const $currentTurn = document.getElementById('turn-status');
        const $buttonGrid = document.getElementById('button-grid');
        const $systemError = document.getElementById('system-error');
        const $displayBetPoints = document.getElementById('display-bet-points');
        const $playerCreatorName = document.getElementById('player-creator-name');
        const $playerJoinerName = document.getElementById('player-joiner-name');
        const $currentGameCode = document.getElementById('current-game-code');
        const $returnToSetup = document.getElementById('return-to-setup');

        /**
         * ç”»é¢é·ç§»ãƒ˜ãƒ«ãƒ‘ãƒ¼
         * @param {string} screenId - 'login', 'setup', 'play'
         */
        function switchScreen(screenId) {
            $loginScreen.classList.add('hidden');
            $gameSetupScreen.classList.add('hidden');
            $gamePlayScreen.classList.add('hidden');
            $systemError.classList.add('hidden');
            
            // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            if (screenId === 'login') {
                $loginScreen.classList.remove('hidden');
            } else if (screenId === 'setup') {
                $gameSetupScreen.classList.remove('hidden');
                // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã£ãŸã‚‰ã€å¾…æ©Ÿä¸­ã®ã‚²ãƒ¼ãƒ ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                startPollingWaitingGames();
            } else if (screenId === 'play') {
                $gamePlayScreen.classList.remove('hidden');
                // ã‚²ãƒ¼ãƒ ç”»é¢ã«å…¥ã£ãŸã‚‰ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                startPollingGameStatus();
            }
        }

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---

        /**
         * å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒã‚·ãƒ¥å«ã‚€ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰
         */
        async function loadAllPlayerData() {
            try {
                // common.jsã®fetchPlayerDataã‚’ä½¿ç”¨
                allPlayerData = await fetchPlayerData(); 
            } catch (error) {
                showMessage($systemError, `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }
        
        // â˜… ä¿®æ­£: hashPasswordã¯common.jsã‹ã‚‰åˆ©ç”¨
        
        $loginButton.addEventListener('click', async () => {
            const playerName = $playerNameInput.value.trim(); // â˜… trim()ã‚’é©ç”¨
            const inputPassword = $passwordInput.value; 

            showMessage($loginError, '', 'error');
            $loginError.classList.add('hidden');

            if (!playerName) {
                showMessage($loginError, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            if (!inputPassword) { 
                showMessage($loginError, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿æ¤œç´¢
            const player = allPlayerData.find(p => p.name === playerName);

            if (!player) {
                showMessage($loginError, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            try {
                // common.jsã®hashPasswordã‚’ä½¿ç”¨ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç©ºç™½ã‚‚trim()
                const hashedPassword = await hashPassword(inputPassword.trim());
                
                // ãƒ‡ãƒ¼ã‚¿å†…ã® 'pass' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ä¸€è‡´ã™ã‚‹ã‹æ¤œè¨¼
                if (player.pass !== hashedPassword) { 
                    showMessage($loginError, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
            } catch (e) {
                // ãƒãƒƒã‚·ãƒ¥åŒ–ã‚¨ãƒ©ãƒ¼
                showMessage($loginError, 'èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                return;
            }

            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ã‚²ãƒ¼ãƒ è¨­å®šç”»é¢ã¸
            localPlayer.name = playerName;
            localPlayer.userId = player.name; 
            localPlayer.passwordHash = player.pass; // èªè¨¼æ¸ˆã¿ã®ãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
            localPlayer.betPoints = 0; // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯0ã€ã‚²ãƒ¼ãƒ ä½œæˆæ™‚ã«è¨­å®š

            console.log(`[LOGIN SUCCESS] Player: ${localPlayer.name}, ID: ${localPlayer.userId}`);

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã€ç”»é¢é·ç§»
            switchScreen('setup');
        });

        // --- ã‚²ãƒ¼ãƒ ä½œæˆ/å‚åŠ å‡¦ç† ---
        // ... [ä»¥é™ã®é–¢æ•°ã¯å¤‰æ›´ãªã—] ...
        
        // --- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---
        window.onload = async () => {
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®š
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            await loadAllPlayerData();
            
            // å¸¸ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰é–‹å§‹
            switchScreen('login');
        };

        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ãã«ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
